<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Location-based AR - Rio Cube</title>
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    
    <!-- A-Frame library -->
    <script src='https://aframe.io/releases/1.3.0/aframe.min.js'></script>
    
    <!-- AR.js for A-Frame (location based) -->
    <script src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js'></script>
    
    <style>
        .info-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            font-family: Arial, sans-serif;
            font-size: 12px;
            z-index: 999;
        }
        
        .status {
            color: #00ff00;
            margin: 5px 0;
        }
        
        .error {
            color: #ff0000;
        }
        
        .warning {
            color: #ffff00;
        }
        
        .distance-info {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-family: Arial, sans-serif;
            z-index: 999;
        }
        
        .capture-btn {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: #ff4444;
            color: white;
            border: 3px solid white;
            border-radius: 50%;
            width: 70px;
            height: 70px;
            font-size: 30px;
            z-index: 999;
            cursor: pointer;
        }
    </style>
</head>

<body style='margin: 0; overflow: hidden;'>
    <div class="info-container" id="info">
        <div>üìç Target Location: Christ the Redeemer Area</div>
        <div>üéØ Coordinates: -22.979750, -43.232894</div>
        <div id="status" class="status">Initializing AR...</div>
        <div id="user-location"></div>
        <div id="accuracy"></div>
    </div>
    
    <div class="distance-info" id="distance">
        Calculating distance...
    </div>
    
    <button class="capture-btn" id="capture" onclick="captureObject()">üì¶</button>

    <!-- AR Scene -->
    <a-scene
        vr-mode-ui='enabled: false'
        arjs='sourceType: webcam; 
              videoTexture: true; 
              debugUIEnabled: false;
              locationMinAccuracy: 1;
              locationMinDistance: 1;'
        embedded
    >
        <!-- Define the cube at the specific location -->
        <!-- Using the exact coordinates near Christ the Redeemer -->
        <a-box
            id="ar-cube"
            material="color: yellow; metalness: 0.7; roughness: 0.3"
            scale="5 5 5"
            position="0 0 0"
            animation="property: rotation; to: 0 360 0; loop: true; dur: 3000"
            animation__2="property: position; to: 0 1 0; dir: alternate; dur: 1000; loop: true"
            gps-new-entity-place="latitude: -22.979750; longitude: -43.232894"
        ></a-box>
        
        <!-- Add a glowing effect around the cube -->
        <a-entity
            light="type: point; intensity: 2; color: #FFD700"
            gps-new-entity-place="latitude: -22.979750; longitude: -43.232894"
        ></a-entity>
        
        <!-- Add a text label above the cube -->
        <a-text
            value="Mystery Cube!"
            look-at="[gps-new-camera]"
            scale="15 15 15"
            position="0 8 0"
            align="center"
            color="#FFFF00"
            font="kelsonsans"
            gps-new-entity-place="latitude: -22.979750; longitude: -43.232894"
        ></a-text>
        
        <!-- Add a ring around the cube for better visibility -->
        <a-ring
            color="#FFD700"
            radius-inner="6"
            radius-outer="8"
            rotation="-90 0 0"
            position="0 -2 0"
            animation="property: rotation; to: -90 360 0; loop: true; dur: 5000"
            gps-new-entity-place="latitude: -22.979750; longitude: -43.232894"
        ></a-ring>

        <!-- Camera with GPS tracking -->
        <a-camera 
            id="camera"
            gps-new-camera="
                simulateLatitude: -22.979750;
                simulateLongitude: -43.232894;
                simulateAltitude: 0;
                positionMinAccuracy: 10;
                minDistance: 1;
                maxDistance: 100000;
                gpsMinDistance: 1;
                gpsTimeInterval: 1000;
            "
            position="0 0 0"
            look-controls
            wasd-controls-enabled="false"
            arjs-device-orientation-controls
        ></a-camera>
    </a-scene>

    <script>
        // Target location (Christ the Redeemer area)
        const TARGET_LAT = -22.979750;
        const TARGET_LON = -43.232894;
        
        let captured = false;
        let userLat = null;
        let userLon = null;
        
        // Calculate distance between two GPS coordinates
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth's radius in meters
            const œÜ1 = lat1 * Math.PI/180;
            const œÜ2 = lat2 * Math.PI/180;
            const ŒîœÜ = (lat2-lat1) * Math.PI/180;
            const ŒîŒª = (lon2-lon1) * Math.PI/180;

            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                    Math.cos(œÜ1) * Math.cos(œÜ2) *
                    Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c; // Distance in meters
        }
        
        // Update UI with current GPS information
        function updateLocationInfo(position) {
            userLat = position.coords.latitude;
            userLon = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            
            // Calculate distance to target
            const distance = calculateDistance(userLat, userLon, TARGET_LAT, TARGET_LON);
            
            // Update UI
            document.getElementById('user-location').innerHTML = 
                `üì± Your Location: ${userLat.toFixed(6)}, ${userLon.toFixed(6)}`;
            document.getElementById('accuracy').innerHTML = 
                `üéØ GPS Accuracy: ${accuracy.toFixed(1)}m`;
            
            // Update distance display
            let distanceText = '';
            if (distance < 10) {
                distanceText = `üéâ CUBE IS HERE! ${distance.toFixed(1)}m away`;
                document.getElementById('distance').style.background = '#00ff00';
                document.getElementById('distance').style.color = '#000';
                
                // Make cube more visible when close
                const cube = document.getElementById('ar-cube');
                if (cube) {
                    cube.setAttribute('scale', '10 10 10');
                    cube.setAttribute('material', 'color: #00ff00; metalness: 0.9; roughness: 0.1');
                }
            } else if (distance < 100) {
                distanceText = `üî• Very Close! ${distance.toFixed(1)}m away`;
                document.getElementById('distance').style.background = 'rgba(255, 165, 0, 0.9)';
            } else if (distance < 1000) {
                distanceText = `üìç ${distance.toFixed(0)}m away`;
                document.getElementById('distance').style.background = 'rgba(0, 0, 0, 0.8)';
            } else {
                const km = (distance / 1000).toFixed(2);
                distanceText = `üìç ${km}km away`;
                document.getElementById('distance').style.background = 'rgba(0, 0, 0, 0.8)';
            }
            
            document.getElementById('distance').innerHTML = distanceText;
            
            // Update status
            if (accuracy <= 20) {
                document.getElementById('status').innerHTML = '‚úÖ GPS Signal: Excellent';
                document.getElementById('status').className = 'status';
            } else if (accuracy <= 50) {
                document.getElementById('status').innerHTML = '‚ö†Ô∏è GPS Signal: Good';
                document.getElementById('status').className = 'warning';
            } else {
                document.getElementById('status').innerHTML = '‚ö†Ô∏è GPS Signal: Poor - Move to open area';
                document.getElementById('status').className = 'warning';
            }
        }
        
        // Handle GPS errors
        function handleLocationError(error) {
            let errorMsg = '';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMsg = "‚ùå Location access denied. Please enable GPS.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMsg = "‚ùå Location information unavailable.";
                    break;
                case error.TIMEOUT:
                    errorMsg = "‚è±Ô∏è Location request timed out.";
                    break;
                default:
                    errorMsg = "‚ùå An unknown error occurred.";
            }
            document.getElementById('status').innerHTML = errorMsg;
            document.getElementById('status').className = 'error';
        }
        
        // Capture the cube (Pokemon Go style interaction)
        function captureObject() {
            if (captured) {
                alert('üéâ You already captured this cube!');
                return;
            }
            
            if (!userLat || !userLon) {
                alert('‚ö†Ô∏è Waiting for GPS location...');
                return;
            }
            
            const distance = calculateDistance(userLat, userLon, TARGET_LAT, TARGET_LON);
            
            if (distance <= 50) { // Within 50 meters
                captured = true;
                alert(`üéâ Congratulations! You captured the Mystery Cube!\n\nDistance: ${distance.toFixed(1)}m\nLocation: Near Christ the Redeemer`);
                
                // Change cube appearance when captured
                const cube = document.getElementById('ar-cube');
                if (cube) {
                    cube.setAttribute('material', 'color: #4CAF50; metalness: 1; roughness: 0');
                    cube.removeAttribute('animation__2');
                }
                
                // Update button
                document.getElementById('capture').innerHTML = '‚úÖ';
                document.getElementById('capture').style.background = '#4CAF50';
            } else {
                alert(`üìç Too far away!\n\nYou need to be within 50m to capture.\nCurrent distance: ${distance.toFixed(1)}m`);
            }
        }
        
        // Initialize location tracking
        window.addEventListener('load', () => {
            if ('geolocation' in navigator) {
                // Start watching position
                navigator.geolocation.watchPosition(
                    updateLocationInfo,
                    handleLocationError,
                    {
                        enableHighAccuracy: true,
                        maximumAge: 0,
                        timeout: 27000
                    }
                );
                
                // Get initial position
                navigator.geolocation.getCurrentPosition(
                    updateLocationInfo,
                    handleLocationError,
                    {
                        enableHighAccuracy: true,
                        maximumAge: 0,
                        timeout: 27000
                    }
                );
            } else {
                document.getElementById('status').innerHTML = '‚ùå Geolocation not supported';
                document.getElementById('status').className = 'error';
            }
        });
        
        // Listen for AR.js events
        window.addEventListener('gps-entity-place-loaded', (e) => {
            console.log('AR cube loaded at GPS location');
        });
        
        window.addEventListener('gps-camera-update-position', (e) => {
            console.log('Camera GPS position updated', e.detail.position);
        });
    </script>
</body>
</html>